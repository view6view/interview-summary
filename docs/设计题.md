# é¡¹ç›®ä»£ç è®¾è®¡

## åŠ¨æ€çš„åŠ¨ç‰©ç®¡ç†å›­

> éœ€æ±‚

- éœ€è¦ä¸€ä¸ªåŠ¨ç‰©ç®¡ç†å‘˜ç±»ï¼Œç®¡ç†ä¸åŒçš„åŠ¨ç‰©ç±»
- åŠ¨ç‰©ç§ç±»çš„ä¸ªæ•°æ˜¯åŠ¨æ€çš„ã€ä¸ç¡®å®šçš„ï¼Œå¯ä»¥æ–°å¢åŠ¨ç‰©ç§ç±»ï¼Œåˆ é™¤åŠ¨ç‰©ç§ç±»
- æ–°å¢åŠ¨ç‰©ï¼Œç”¨æˆ·å¯ä»¥æ–°å¢ä¸€ä¸ªåŠ¨ç‰©ï¼ŒåŠ¨ç‰©ç®¡ç†å‘˜éœ€è¦æ ¹æ®åŠ¨ç‰©çš„ç§ç±»è¿›è¡ŒåŒºåˆ†å¤„ç†ï¼Œå°†åŠ¨ç‰©åŠ å…¥
- åˆ é™¤åŠ¨ç‰©ï¼Œç”¨æˆ·ä¼ å…¥ä¸€ä¸ªåŠ¨ç‰©å¯¹è±¡ï¼ŒåŠ¨ç‰©ç®¡ç†å‘˜éœ€è¦åˆ¤æ–­åŠ¨ç‰©çš„ç±»å‹å¹¶ä¸”åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¹¶ä¸”è¿›è¡Œåˆ é™¤
- ç»Ÿè®¡ç”¨æˆ·æ•°é‡ï¼Œç”¨æˆ·ä¼ å…¥åŠ¨ç‰©ç±»å‹ï¼Œéœ€è¦è¿”å›å‡ºå¯¹åº”åŠ¨ç‰©ç±»å‹çš„æ•°é‡
- åœ¨å¤šçº¿ç¨‹æ‰§è¡Œæƒ…å†µä¸‹ï¼Œå¦‚ä½•æ—¢å……åˆ†åˆ©ç”¨èµ„æºåˆé«˜æ•ˆçš„ä¿è¯æ•°æ®ä¸€è‡´

> è®¾è®¡æ€è·¯

- ä»£ç è®¾è®¡æˆªå›¾ï¼ŒåŒ…å«å¤šçº¿ç¨‹æ‰§è¡Œå™¨ç”¨äºæµ‹è¯•ã€ZooåŠ¨ç‰©ç®¡ç†å‘˜å¯¹è±¡ï¼ŒmodelåŠ¨ç‰©ç±»

![image-20220519172542477](images/image-20220519172542477.png)

- åŠ¨ç‰©ç±»ä¸ºä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå£°æ˜åŠ¨ç‰©çš„å…±æœ‰å±æ€§å’ŒæŠ½è±¡æ–¹æ³•ï¼Œå…·ä½“çš„åŠ¨ç‰©ç±»ç»§æ‰¿è¿™ä¸ªæŠ½è±¡

```java
public abstract class Animal{}
public class Cat extends Animal{}
public class Dog extends Animal{}
```

- åŠ¨ç‰©ç®¡ç†å‘˜ï¼Œç»´æŠ¤ä¸€ä¸ªMapï¼ŒKeyä¸º`Class<T>`å¯¹è±¡ï¼ŒValueä¸ºä¸€ä¸ªé“¾è¡¨`List<Animal>`

```java
private Map<Class<? extends Animal>, List<Animal>> map = new ConcurrentHashMap<>();
```

- æ–°å¢åŠ¨ç‰©çš„æ—¶å€™ï¼Œæ ¹æ®åŠ¨ç‰©çš„`Class`å¯¹è±¡åˆ¤æ–­åŠ¨ç‰©çš„ç±»å‹ï¼Œç„¶åå¯¹å½“å‰è¿™ä¸ª`Class`å¯¹è±¡åŠ é”ï¼Œä»Mapä¸­å–å‡ºå¯¹åº”çš„åŠ¨ç‰©é“¾è¡¨ï¼Œç„¶åæ“ä½œå¯¹åº”çš„é“¾è¡¨æ•°æ®ï¼Œåˆ é™¤åŒç†

> ä»£ç 

- executor

```java
import com.wu.scene.animal.model.Cat;
import com.wu.scene.animal.model.Dog;
import com.wu.scene.animal.manager.Zoo;

import java.util.UUID;

public class Executor1 implements Runnable {
    private Zoo zoo;

    public Executor1(Zoo zoo) {
        this.zoo = zoo;
    }

    /**
     * æ’å…¥10000æ¡catï¼Œ5000æ¡dog
     */
    @Override
    public void run() {
        for (int i = 0; i < 5000; i++) {
            zoo.addAnimal(new Dog("dog" + UUID.randomUUID().toString()));
            zoo.addAnimal(new Cat("cat" + UUID.randomUUID().toString()));
            zoo.addAnimal(new Cat("cat" + UUID.randomUUID().toString()));
        }
    }
}
```

```java
import java.util.UUID;

public class Executor2 implements Runnable{
    private Zoo zoo;

    public Executor2(Zoo zoo) {
        this.zoo = zoo;
    }

    /**
     * æ’å…¥10000æ¡dogï¼Œ5000æ¡cat
     */
    @Override
    public void run() {
        for (int i = 0; i < 5000; i++) {
            zoo.addAnimal(new Dog("dog" + UUID.randomUUID().toString()));
            zoo.addAnimal(new Dog("dog" + UUID.randomUUID().toString()));
            zoo.addAnimal(new Cat("cat" + UUID.randomUUID().toString()));
        }
    }
}
```

- model

```java
public abstract class Animal {
    private String name;

    public Animal(String name) {
        this.name = name;
    }

    public abstract void call();
}

public class Cat extends Animal{
    public Cat(String name) {
        super(name);
    }

    @Override
    public void call() {
        System.out.println("cat");
    }
}

public class Dog extends Animal {
    public Dog(String name) {
        super(name);
    }

    @Override
    public void call() {
        System.out.println("dog");
    }
}
```

- manager

```java
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

public class Zoo {
    private Map<Class<? extends Animal>, List<Animal>> map = new ConcurrentHashMap<>();

    public void addAnimal(Animal animal) {
        Class<? extends Animal> animalType = animal.getClass();
        synchronized (animalType) {
            List<Animal> animals = map.get(animalType);
            if (animals == null) {
                LinkedList<Animal> list = new LinkedList<>();
                list.add(animal);
                map.put(animalType, list);
            } else {
                animals.add(animal);
            }
        }
    }

    public boolean deleteAnimal(Animal animal) throws RuntimeException {
        Class<? extends Animal> animalType = animal.getClass();
        synchronized (animalType) {
            List<Animal> animals = map.get(animalType);
            if (animals == null) {
                throw new RuntimeException("such animal type is null");
            }
            if (animals.contains(animal)) {
                animals.remove(animal);
                return true;
            } else {
                throw new RuntimeException("no such animal in zoo");
            }
        }
    }

    public int countAnimalByType(Class<? extends Animal> type) {
        List<Animal> animals = map.get(type);
        return animals == null ? 0 : animals.size();
    }
}
```

# å¦‚ä½•æœ‰æ•ˆé¿å…tokenæ³„éœ²å¯¼è‡´çš„å®‰å…¨é—®é¢˜

- é¦–å…ˆï¼ŒToken ä¸€èˆ¬æ”¾åœ¨ Header æˆ–è€… Cookies ä¸­ï¼ŒHttp æ˜¯æ˜æ–‡ä¼ è¾“ï¼ŒHttps æ˜¯å¯†æ–‡ä¼ è¾“ã€‚å¯ä»¥ä¸€å®šç¨‹åº¦é˜²æ­¢Token æˆªè·ã€‚
- ç¬¬äºŒï¼ŒToken ä¸€èˆ¬ä¼šå’Œ Ipï¼ŒMACåœ°å€ï¼Œæˆ–è€… DeviceID è¿›è¡Œç»‘å®šã€‚å¦‚æœæœåŠ¡ç«¯æ£€æµ‹è¿™äº›å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯ä»¥å°† Token å¤±æ•ˆè®©ç”¨æˆ·é‡æ–°ç™»å½•ã€‚
- ç¬¬ä¸‰ï¼ŒToken å¯ä»¥åŠ å¯†ï¼Œä¾‹å¦‚AESå¯¹ç§°åŠ å¯†ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å…ˆäº¤æ¢å¯¹ç§°ç§˜é’¥ä¹‹åç”¨å¯¹ç§°ç§˜é’¥å°† Token + å½“å‰æ—¶é—´æˆ³ å¯¹ç§°åŠ å¯†åå‘å¾€æœåŠ¡ç«¯è§£å¯†éªŒè¯ Token å’Œæ—¶é—´æˆ³éƒ½æœ‰æ•ˆã€‚æˆ–è€…ç›´æ¥é€šè¿‡ RSA å…¬é’¥åŠ å¯†ã€‚å¢åŠ äº†æˆªå–æˆæœ¬ã€‚
- ç¬¬å››ï¼Œæ•æ„Ÿæ“ä½œä¸€èˆ¬è¦æ±‚äºŒæ¬¡å®‰å…¨éªŒè¯ï¼Œä¾‹å¦‚æ”¯ä»˜çš„æ—¶å€™ï¼Œéœ€è¦æ”¯ä»˜å¯†ç ï¼Œæˆ–è€…éªŒè¯æ‰‹æœºçŸ­ä¿¡éªŒè¯ç ç­‰ç­‰ã€‚

# Nginxæ­£å‘åå‘ä»£ç†åŒºåˆ«åŠåŸç†

## æ­£å‘ä»£ç†å’Œåå‘ä»£ç†

> æ­£å‘ä»£ç†

æ­£å‘ä»£ç†æœåŠ¡å™¨ä½äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œä¸ºäº†ä»æœåŠ¡å™¨è·å–æ•°æ®ï¼Œå®¢æˆ·ç«¯è¦å‘ä»£ç†æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶æŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å°†ç›®æ ‡æœåŠ¡å™¨è¿”å›çš„æ•°æ®è½¬äº¤ç»™å®¢æˆ·ç«¯ã€‚è¿™é‡Œå®¢æˆ·ç«¯éœ€è¦è¦è¿›è¡Œä¸€äº›æ­£å‘ä»£ç†çš„è®¾ç½®çš„ã€‚

æ­£å‘ä»£ç†ä¸­è¢«ä»£ç†çš„æ˜¯å®¢æˆ·ç«¯çš„è¯·æ±‚

> åå‘ä»£ç†

åå‘ä»£ç†ï¼Œå®¢æˆ·ç«¯å¯¹ä»£ç†æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦ä»»ä½•é…ç½®å°±å¯ä»¥è®¿é—®ï¼Œå®¢æˆ·ç«¯å°†è¯·æ±‚å‘é€åˆ°åå‘ä»£ç†æœåŠ¡å™¨ï¼Œç”±åå‘ä»£ç†æœåŠ¡å™¨å»é€‰æ‹©ç›®æ ‡æœåŠ¡å™¨è·å–æ•°æ®åï¼Œåœ¨è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶åå‘ä»£ç†æœåŠ¡å™¨å’Œç›®æ ‡æœåŠ¡å™¨å¯¹å¤–å°±æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ï¼Œæš´éœ²çš„æ˜¯ä»£ç†æœåŠ¡å™¨åœ°å€ï¼Œéšè—äº†çœŸå®æœåŠ¡å™¨IPåœ°å€ã€‚

> nginxgæ­£å‘ä»£ç†çš„ä½¿ç”¨

æ­£å‘ä»£ç†æœåŠ¡ä½¿ç”¨ç¤ºä¾‹ï¼š

```nginx
server {    
    listen    8080;    
    server_name localhost;         
    location /default/ {      
      proxy_pass http://localhost;    
    } 
}
```

ä»¥ä¸Šçš„é…ç½®ä¸­,

listen è¡¨ç¤ºnginxè¦ç›‘å¬çš„ç«¯å£;

server_name å°±æ˜¯è®¿é—®nginxæ—¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥çš„åŸŸå,å¯ä»¥ç›´æ¥å¡«ipåœ°å€,è¦ç»‘å®šå¤šä¸ªå¯ä»¥ç”¨ç©ºæ ¼éš”å¼€;

location è¡¨ç¤ºnginxç›‘å¬è¯¥ç«¯å£æ—¶è¦åŒ¹é…çš„url,å¦‚æœè®¿é—®nginxçš„urlä¸­åŒ…å«æœ‰/default/å°±æ‰§è¡Œä»£ç†

proxy_pass è¡¨ç¤ºnginxè¦æŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚ä»£ç†åˆ°çš„ç›®æ ‡ã€‚

# æµ…æFastJSONååºåˆ—åŒ–æ¼æ´

https://cloud.tencent.com/developer/article/1957185

# FastJSON ç®€ä»‹

FastJson æ˜¯ä¸€ä¸ªç”±é˜¿é‡Œå·´å·´ç ”å‘çš„javaåº“ï¼Œå¯ä»¥æŠŠjavaå¯¹è±¡è½¬æ¢ä¸ºJSONæ ¼å¼ï¼Œä¹Ÿå¯ä»¥æŠŠJSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡ã€‚

https://github.com/alibaba/fastjson ğŸ‘ˆé¡¹ç›®åœ°å€

â€œè‡ª2017å¹´3æœˆ15æ—¥ï¼Œfastjsonå®˜æ–¹ä¸»åŠ¨çˆ†å‡ºå…¶åœ¨`1.2.24`åŠä¹‹å‰ç‰ˆæœ¬å­˜åœ¨è¿œç¨‹ä»£ç æ‰§è¡Œé«˜å±å®‰å…¨æ¼æ´ä»¥æ¥ï¼Œå„ç§æ–°å‹ç»•è¿‡å§¿åŠ¿å±‚å‡ºä¸ç©·ã€‚â€œâ€”â€”c014

# FASTJSONå’‹ç”¨

ç­”æ¡ˆï¼šç›´æ¥POMå¯¼å…¥ï¼Œæ–¹ä¾¿åœ°ä¸€æ‰¹

```javascript
<dependencies>
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>x.x.xx</version>
    </dependency>
</dependencies>
```

import com.alibaba.fastjson.JSON

fastjsonæœ‰ä¸¤ç§å¸¸è§çš„å¤„ç†JSONçš„æ–¹æ³•

- `JSON.toJSONString()`æ–¹æ³•ï¼šå¯å°†å¯¹è±¡è½¬æ¢æˆ`JSON`å­—ç¬¦ä¸²
- `JSON.parseObject()`æ–¹æ³•ï¼šå°†`JSON`å­—ç¬¦ä¸²è½¬æ¢æˆå¯¹è±¡ã€‚

ä¸‹é¢çœ‹ä¸€æ³¢å®ä¾‹ï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå°†å…¶è½¬ä¸ºJSONï¼Œç„¶åå†è½¬å›å¯¹è±¡ã€‚ åŒæ—¶å¯ä»¥å‘ç°ï¼Œåœ¨JSONåºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„getxxxæ–¹æ³•ï¼›åœ¨JSONååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•

```javascript
public class App 
{
    public static class User{
        private String id;
        User(){
            System.out.println("User go");
        }
        public void setId(String ids){
            System.out.println("setId go");
            this.id=ids;
        }
        public String getId(){
            System.out.println("GetId go");
            return this.id;
        }
    }

    public static void main(String[] args){
        User a = new User();
        String json = JSON.toJSONString(a);
        System.out.println(json);
        System.out.println(JSON.parseObject(json,User.class));
    }
}
```

```javascript
User go
GetId go
{}
User go
org.example.App$User@36d4b5c
```

# FASTJSON ååºåˆ—åŒ–æ¼æ´èµ·æº

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŠŠJSONååºåˆ—åŒ–çš„è¯­å¥æ˜¯ JSON.parseObject(json,User.class)ï¼Œåœ¨æŒ‡å®šJSONæ—¶ï¼Œè¿˜éœ€è¦æŒ‡å®šå…¶æ‰€å±çš„ç±»ï¼Œæ˜¾å¾—ä»£ç å°±å¾ˆè‡ƒè‚¿ï¼Œæ‰€ä»¥å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨@type(autotype)å­—ç¬¦æ®µæ¥ä½¿å…¶ä¸é‚£ä¹ˆè‡ƒè‚¿ã€‚ åƒä¸‹é¢è¿™æ ·ï¼Œåœ¨JSONé€šè¿‡æŒ‡å®š@typeçš„å€¼æ¥å®ç°å®šä½æŸç±»ã€‚

```javascript
JSON.parseObject("{\"@type\":\"org.example.App$User\",\"id\":\"123\"}")
```

è™½è¯´è¿™ä¹ˆåšå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä»¥è¿™ç§æ–¹æ³•è¿›è¡Œååºåˆ—åŒ–ï¼Œä¼šæ‰§è¡Œç±»çš„æ„é€ æ–¹æ³•å’Œå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚

```javascript
public class App 
{
    public static class User{
        private String id;
        User(){
            System.out.println("User go");
        }
        public void setId(String ids){
            System.out.println("setId go");
            this.id=ids;
        }
        public String getId(){
            System.out.println("GetId go");
            return this.id;
        }
    }

    public static void main(String[] args){
        System.out.println(JSON.parseObject("{\"@type\":\"org.example.App$User\",\"id\":\"123\"}"));
    }
}
```

```javascript
User go
setId go
GetId go
{"id":"123"}
```

æ‰€ä»¥åœ¨è¿™ä¸ªJSONååºåˆ—åŒ–æ¥å£å¤„ï¼Œæˆ‘ä»¬ä¼ å…¥æ¶æ„çš„JSONï¼Œå°±å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„æ„é€ æ–¹æ³•ä»¥åŠå±æ€§ç›¸å…³çš„getï¼Œsetæ–¹æ³•ã€‚ å¦‚æœæŸç±»çš„ç›¸å…³æ–¹æ³•é‡Œæœ‰å±é™©çš„ä»£ç ï¼ˆå¦‚æ‰§è¡ŒæŸä¸ªå‘½ä»¤ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ æ¶æ„JSONè¾¾åˆ°RCEçš„ä½œç”¨ã€‚

å¦å¤–ï¼ŒJSON.parseObject(â€œ{"@type":"org.example.App$User","id":"123"}â€,Feature.SupportNonPublicField) ï¼Œå¯ä»¥ç›´æ¥ä¸ºprivateæˆå‘˜èµ‹å€¼ï¼ˆä¸åŠ Feature.SupportNonPublicFieldæ˜¯æ— æ³•å¯¹privateæˆå‘˜èµ‹å€¼çš„ï¼‰
